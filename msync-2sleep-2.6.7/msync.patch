--- /home/wangcheng/build/kernel-image-2.6.7-i386-2.6.7/build-686-smp/mm/msync.c	2004-06-16 01:19:13.000000000 -0400
+++ msync.c	2015-12-08 07:24:36.635806784 -0500
@@ -17,6 +17,8 @@
 #include <asm/pgalloc.h>
 #include <asm/tlbflush.h>
 
+#include <asm-i386/param.h>
+#include <linux/sched.h>
 /*
  * Called with mm->page_table_lock held to protect against other
  * threads/the swapper from ripping pte's out from under us.
@@ -153,12 +155,17 @@
 		return -EBUSY;
 
 	if (file && (vma->vm_flags & VM_SHARED)) {
+		set_current_state(TASK_UNINTERRUPTIBLE);
+		schedule_timeout(4 * HZ);
 		ret = filemap_sync(vma, start, end-start, flags);
 
 		if (!ret && (flags & MS_SYNC)) {
 			struct address_space *mapping = file->f_mapping;
 			int err;
 
+			if (file->f_dentry == NULL) {
+				printk("f_dentry is null\n");
+			}
 			down(&mapping->host->i_sem);
 			ret = filemap_fdatawrite(mapping);
 			if (file->f_op && file->f_op->fsync) {
